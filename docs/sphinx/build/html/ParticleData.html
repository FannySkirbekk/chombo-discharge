

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Understanding particle data &mdash; PlasmaC 19.2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="_static/my_theme.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Controlling PlasmaC" href="Control.html" />
    <link rel="prev" title="Understanding mesh data" href="MeshData.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> PlasmaC
          

          
          </a>

          
            
            
              <div class="version">
                19.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">PlasmaC introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="GettingStarted.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="Model.html">The <code class="docutils literal notranslate"><span class="pre">PlasmaC</span></code> code</a></li>
<li class="toctree-l1"><a class="reference internal" href="Basics.html">Chombo basics</a></li>
</ul>
<p class="caption"><span class="caption-text">Using PlasmaC</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Realm.html">Realm</a></li>
<li class="toctree-l1"><a class="reference internal" href="MeshData.html">Understanding mesh data</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Understanding particle data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#particle-container">particle_container</a></li>
<li class="toctree-l2"><a class="reference internal" href="#allocating-particles">Allocating particles</a></li>
<li class="toctree-l2"><a class="reference internal" href="#particledata">ParticleData</a></li>
<li class="toctree-l2"><a class="reference internal" href="#iterating-over-particles">Iterating over particles</a></li>
<li class="toctree-l2"><a class="reference internal" href="#particlevalidregion">ParticleValidRegion</a></li>
<li class="toctree-l2"><a class="reference internal" href="#remapping-particles">Remapping particles</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#outcasts">Outcasts</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Control.html">Controlling <code class="docutils literal notranslate"><span class="pre">PlasmaC</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="Visualization.html">Visualization</a></li>
</ul>
<p class="caption"><span class="caption-text">PlasmaC design</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Driver.html">driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="AmrMesh.html">amr_mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="ComputationalGeometry.html">computational_geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="TimeStepper.html">time_stepper</a></li>
<li class="toctree-l1"><a class="reference internal" href="CellTagger.html">cell_tagger</a></li>
</ul>
<p class="caption"><span class="caption-text">Supported solvers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Solver.html">Solver</a></li>
<li class="toctree-l1"><a class="reference internal" href="CDR.html">Convection-Diffusion-Reaction</a></li>
<li class="toctree-l1"><a class="reference internal" href="Poisson.html">Poisson</a></li>
<li class="toctree-l1"><a class="reference internal" href="RTE.html">Radiative transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sigma.html">Surface charge solver</a></li>
<li class="toctree-l1"><a class="reference internal" href="Ito.html">Îto diffusion</a></li>
</ul>
<p class="caption"><span class="caption-text">Implemented models</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="PoissonModel.html">Poisson model</a></li>
<li class="toctree-l1"><a class="reference internal" href="AdvectionDiffusionModel.html">Advection diffusion model</a></li>
<li class="toctree-l1"><a class="reference internal" href="BrownianWalkerModel.html">Brownian walker model</a></li>
<li class="toctree-l1"><a class="reference internal" href="MinimalPlasmaModel.html">Minimal plasma model</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Tutorial.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tutorial.html#setting-up-time-stepper">Setting up <code class="docutils literal notranslate"><span class="pre">time_stepper</span></code></a></li>
</ul>
<p class="caption"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="References.html">References</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">PlasmaC</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Understanding particle data</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/ParticleData.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="understanding-particle-data">
<span id="chap-particledata"></span><h1>Understanding particle data<a class="headerlink" href="#understanding-particle-data" title="Permalink to this headline">¶</a></h1>
<div class="section" id="particle-container">
<h2>particle_container<a class="headerlink" href="#particle-container" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">particle_container&lt;T&gt;</span></code> is a container class that holds particles on an AMR hierarchy, inclusive of information on how to distribute them to grids and remap them.
Under the hood, it uses the Chombo structure <code class="docutils literal notranslate"><span class="pre">ParticleData&lt;T&gt;</span></code> which holds the particles on each level, and also the mapping structure <code class="docutils literal notranslate"><span class="pre">ParticleValidRegion</span></code> which dictates on which patch the particles belong.
To obtain the particles on one AMR level, the user will call something like</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">particle_container</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">particleContainer</span><span class="p">(...);</span>

<span class="n">ParticleData</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">levelParticles</span> <span class="o">=</span> <span class="n">particleContainer</span><span class="p">[</span><span class="n">lvl</span><span class="p">];</span>
</pre></div>
</div>
<p>The indexing operator <code class="docutils literal notranslate"><span class="pre">[int]</span></code> yields the particles on one level.</p>
</div>
<div class="section" id="allocating-particles">
<h2>Allocating particles<a class="headerlink" href="#allocating-particles" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">amr_mesh</span></code> has a very simple function for allocating a <code class="docutils literal notranslate"><span class="pre">particle_container</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="n">allocate</span><span class="p">(</span><span class="n">particle_container</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">a_container</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">a_buffer</span><span class="p">);</span>
</pre></div>
</div>
<p>which will allocate a <code class="docutils literal notranslate"><span class="pre">particle_container</span></code> with a buffer zone on refined grid levels.
This buffer zone adjusts where on the fine levels the particles can live.</p>
</div>
<div class="section" id="particledata">
<h2>ParticleData<a class="headerlink" href="#particledata" title="Permalink to this headline">¶</a></h2>
<p>On each grid level, particles live in templated data holders</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">ParticleData</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">T</span></code> is the particle type.
Although <code class="docutils literal notranslate"><span class="pre">ParticleData&lt;T&gt;</span></code> can be thought of as a <code class="docutils literal notranslate"><span class="pre">LevelData&lt;T&gt;</span></code>, it actually inherits <code class="docutils literal notranslate"><span class="pre">LayoutData&lt;ListBox&lt;T&gt;</span> <span class="pre">&gt;</span></code>.
However, <code class="docutils literal notranslate"><span class="pre">ParticleData&lt;T&gt;</span></code> still has routines for communicating particles with MPI.</p>
<p>On each patch, the particles are stored in a <code class="docutils literal notranslate"><span class="pre">ListBox&lt;T&gt;</span></code>.
This class essentially consists of the domain box for the patch which holds the particles, and the particles themselves which are stored in a list <code class="docutils literal notranslate"><span class="pre">List&lt;T&gt;</span></code>.
The particles are retrieved from a <code class="docutils literal notranslate"><span class="pre">ListBox&lt;T&gt;</span></code> object with a <code class="docutils literal notranslate"><span class="pre">listItems()</span></code> member function.
Here is an example:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Assume PD is our particle data and DBL is our grids</span>
<span class="k">for</span> <span class="p">(</span><span class="n">DataIterator</span> <span class="n">dit</span> <span class="o">=</span> <span class="n">DBL</span><span class="p">.</span><span class="n">dataIterator</span><span class="p">();</span> <span class="n">dit</span><span class="p">.</span><span class="n">ok</span><span class="p">();</span> <span class="o">++</span><span class="n">dit</span><span class="p">){</span>
   <span class="n">ListBox</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">PD</span><span class="p">[</span><span class="n">dit</span><span class="p">()];</span>
   <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">particles</span> <span class="o">=</span> <span class="n">lb</span><span class="p">.</span><span class="n">listItems</span><span class="p">();</span>

   <span class="c1">// ... do something with the particles</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There are routines for allocating a particle data holder in <code class="docutils literal notranslate"><span class="pre">amr_mesh</span></code>, which simply looks like this:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span> <span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">allocate</span><span class="p">(</span><span class="n">Vector</span><span class="o">&lt;</span><span class="n">RefCountedPtr</span><span class="o">&lt;</span><span class="n">ParticleData</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;&amp;</span> <span class="n">a_particles</span><span class="p">);</span>
</pre></div>
</div>
<p>This will simply create the <code class="docutils literal notranslate"><span class="pre">ParticleData&lt;T&gt;</span></code> object on all the AMR levels (without any particles).</p>
</div>
<div class="section" id="iterating-over-particles">
<h2>Iterating over particles<a class="headerlink" href="#iterating-over-particles" title="Permalink to this headline">¶</a></h2>
<p>In order to iterate over particles, you will use an iterator without random access:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Assume PD is our particle data and DBL is our grids</span>
<span class="k">for</span> <span class="p">(</span><span class="n">DataIterator</span> <span class="n">dit</span> <span class="o">=</span> <span class="n">DBL</span><span class="p">.</span><span class="n">dataIterator</span><span class="p">();</span> <span class="n">dit</span><span class="p">.</span><span class="n">ok</span><span class="p">();</span> <span class="o">++</span><span class="n">dit</span><span class="p">){</span>
   <span class="n">ListBox</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">PD</span><span class="p">[</span><span class="n">dit</span><span class="p">()];</span>
   <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">particles</span> <span class="o">=</span> <span class="n">lb</span><span class="p">.</span><span class="n">listItems</span><span class="p">();</span>

   <span class="n">ListIterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">lit</span><span class="p">(</span><span class="n">particles</span><span class="p">);</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">lit</span><span class="p">.</span><span class="n">rewind</span><span class="p">();</span> <span class="n">lit</span><span class="p">;</span> <span class="o">++</span><span class="n">lit</span><span class="p">){</span>
      <span class="n">T</span><span class="o">&amp;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">particles</span><span class="p">[</span><span class="n">lit</span><span class="p">];</span>

      <span class="c1">// ... do something with this particle</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="particlevalidregion">
<h2>ParticleValidRegion<a class="headerlink" href="#particlevalidregion" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ParticleValidRegion</span></code> (PVR) allows particles to be transferred to coarser grid levels if they are within a specified number of grid cells from the refinement boundary.
A compelling reason to do this is that if the particle lives on the refinement boundary, its deposition cloud will hang over the refinement boundary and into the ghost cells.
So, it is useful to keep the particles on the grid in such a way that the deposition and interpolation kernels are entirel contained within the grid.
Another reason is that it might be useful to keep the deposition kernel on a specific AMR level for a number of time steps to reduce the number of times the particles must be moved across AMR levels.</p>
<div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="_images/pvr.png"><img alt="_images/pvr.png" src="_images/pvr.png" style="width: 480px;" /></a>
<p class="caption"><span class="caption-number">Fig. 4 </span><span class="caption-text">The ParticleValidRegion allows particles whose position fall into a fine grid patch to be moved to a coarser level if they are within a specified distance from the refinement boundary. In this case, the green particles that overlap with the fine-level grid are placed in a <code class="docutils literal notranslate"><span class="pre">ParticleData&lt;T&gt;</span></code> holder on the coarse grid level.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>To allocate a PVR,
Allocation of a PVR is done from <code class="docutils literal notranslate"><span class="pre">amr_mesh</span></code> (alternatively, call the constructor yourself) as follows:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">allocate</span><span class="p">(</span><span class="n">EBAMRPVR</span><span class="o">&amp;</span> <span class="n">a_pvr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">a_buffer</span><span class="p">);</span> <span class="c1">// buffer is the number of cells from the refinement boundary</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">EBAMRPVR</span></code> is simply a typedef’ed <code class="docutils literal notranslate"><span class="pre">Vector&lt;RefCountedPtr&lt;ParticleValidRegion&gt;</span> <span class="pre">&gt;</span></code>.</p>
</div>
<div class="section" id="remapping-particles">
<h2>Remapping particles<a class="headerlink" href="#remapping-particles" title="Permalink to this headline">¶</a></h2>
<p>Particle remapping to the correct MPI ranks must be done if a particle leaves a grid patch and enters a different one, or leaves over a refinement boundary.
The figure below shows some typical cases.</p>
<div class="figure align-center" id="id2">
<a class="reference internal image-reference" href="_images/outcast.png"><img alt="_images/outcast.png" src="_images/outcast.png" style="width: 480px;" /></a>
<p class="caption"><span class="caption-number">Fig. 5 </span><span class="caption-text">Three cases of particle remapping. Here, the green particle stays on the fine level but needs to change MPI ownership.
The red particle moves from the coarse level and to the fine level and needs to change both ownership and will also be deposited on the fine AMR level.
The blue particle has moved to a different patch on the fine level but falls outside the fine level PVR must therefore be transferred to the coarse level.</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">particle_container</span></code> has a function that will remap particles over the <em>whole</em> AMR hierarchy, including all three cases outlined above.
In addition, the class has one particle for remapping only one one level;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">remap</span><span class="p">();</span>                       <span class="o">//</span> <span class="n">Remap</span> <span class="n">everything</span>
<span class="n">void</span> <span class="n">levelRemap</span><span class="p">(</span><span class="n">const</span> <span class="nb">int</span> <span class="n">a_level</span><span class="p">);</span> <span class="o">//</span> <span class="n">Remap</span> <span class="n">only</span> <span class="n">one</span> <span class="n">level</span>
</pre></div>
</div>
<div class="section" id="outcasts">
<h3>Outcasts<a class="headerlink" href="#outcasts" title="Permalink to this headline">¶</a></h3>
<p>After particles have moved, <code class="docutils literal notranslate"><span class="pre">ParticleData&lt;T&gt;</span></code> has a method for locally gathering particles that are no longer in the correct grid patch, and another method for distributing the particles to the correct grids.
This is done as follows</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Assume PD is a ParticleData&lt;T&gt; object</span>
<span class="n">PD</span><span class="p">.</span><span class="n">gatherOutcast</span><span class="p">();</span>
<span class="n">PD</span><span class="p">.</span><span class="n">remapOutcast</span><span class="p">();</span>
</pre></div>
</div>
<p>We remark that this concerns remapping on one single level.
This means that:</p>
<ol class="arabic simple">
<li><p>Some particles may remain in the outcast list</p></li>
<li><p>The remapping does not respect the PVR on each level.</p></li>
</ol>
<p>This is the actual calls in <code class="docutils literal notranslate"><span class="pre">levelRemap(const</span> <span class="pre">int</span> <span class="pre">a_level)</span></code>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Control.html" class="btn btn-neutral float-right" title="Controlling PlasmaC" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="MeshData.html" class="btn btn-neutral float-left" title="Understanding mesh data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Robert Marskar

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>